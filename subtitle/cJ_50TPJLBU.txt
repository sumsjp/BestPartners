大家好这里是最佳拍档我是小郭
前段时间
大飞分享了一期 Mini-GPT4 的介绍以后
很多朋友问安装相关的问题
今天就给大家分享一下
如何在本地安装 Mini-GPT4
Mini GP4 的安装其实并不复杂
就像官网的介绍
它只需要三步就可以了
但是如果国内的小伙伴来安装的话
情况就会稍微复杂一些
其中还有一些小坑
不过没有关系
我都已经帮大家踩过了
话不多说咱们开始今天的内容
先来说一下硬件环境
Mini-GPT4 的运行需要 NVIDIA 的显卡
所以如果是使用
苹果芯片的电脑的朋友的话
就需要找其他的机器来运行了
另外 Mini-GPT4 使用的 Vicuna
需要比较大的显存
如果你运行 13B 的话
大概需要 23G 的 GPU（显存）
如果你没有这么好的配置
可以试试 7B
大概有 11.5G 12G 的显存就可以了
另外下载这些模型参数的文件
还有Python（/ˈpaɪθən/，读错了）的依赖包
也需要比较大的磁盘空间
整个安装下来大概需要100G的空间
建议系统的可用空间有150G以上
对于 CPU 和内存
倒是没有提到具体的要求
咱们这里使用的服务器是至强 5218
一个 64 核 2.3GHz 的处理器
内存是 256GB
操作系统的话
Linux 和 Windows 应该都可以
推荐使用是 Ubuntu
咱们这里使用的操作系统是 Ubuntu 22.04
软件的话
只需要用到 git 和 git-lfs
还有一个你常用的文本编辑器就够了
不需要单独安装 Python
因为安装 Conda 的时候
它会自带了一个 Python
当然
如果你的系统已经安装了也无所谓
呃这里推荐大家使用一个
终端的复用软件
这样可以在一个终端里同时进行多个操作
另外如果你通过 SSH 连接到远程终端
如果在 SSH 断开的时候
终端复用软件还可以保持
之前运行的程序继续运行
这在网络不稳定的情况下
是非常有用的
接下来
先给大家看看安装所需要的所有文件
我把所有的文件都放到了/opt/migigpt4 之下
接下来使用的一些命令和
配置中的内容
也都是基于这个目录的
在实际安装的时候
根据实际情况来进行相应的调整
这个就是安装所需要的所有的文件了
这个是 Conda 的安装文件
就是创建虚拟环境时候使用的
然后 env（目录）是他创建的虚拟环境
他会把所有的
依赖包都装到这一个目录下
这个是 Mini-GPT4 的原码
这个还有这个
这两个是在程序里边
就是在它的源码里边
呃运行的时候
再去从网上下载的两个文件
如果你的梯子不是很稳定的话
因为这两个文件比较大
尤其是这个文件
如果你梯子不是很稳定的话建议先
用浏览器下载下来
然后咱们通过改原码的方式
让他去读这个
咱们预先下载好的文件
而不是现从网上去下载
那样的话
失败的概率很高
这两个这个是 LLAMA 的那个模型
这个是 Vicuna 的
它叫差异模型
就是它和 LLAMA 之间的差异
因为 LLAMA 的
它规定说你不能
再次发行我这个东西
我们可以看一下它的说明
按照正常的流程
你是需要填一个申请表
然后等他
审核通过了以后
就是这个 this form by feeling this form
审核通过了以后
你才能去用他的这个文件
这里就一些基本信息
然后你是哪里的
在底下有他的 License Agreement
底下有提到说你
不能干这个不能干那个的
但是咱们实际是
可以在他通过之前是拿到这个文件的
就是这个文件就放到这个
这个网页上也可以通过 Git 来直接下载了
可以通过 Git 来直接下载了
就是这个地址
但是如果你想再发布的话
是要遵循它的那个 License 限制的
最后这个 vicuna 的目录就是
把这两个模型合并之后的产出物
基本上就是这些文件
这些文件加起来
是大概 99G 的样子
然后运行的时候
可能还会有往其他的地儿
去写一些文件
所以建议
留 100-150 左右的样子吧
整个 Mini-GPT4 的安装一共分为 5 个步骤
第一是下载依赖的文件
然后第二是创建虚拟环境
第三步是合并这个模型文件
第四步是修改配置
第五步是就是启动程序了
然后其中前两步就是最关键也是
最耗时的两步
因为他需要从网上去
下载大量的文件
都比较大
像刚才看的这个模型文件有 20 多个 G
现在咱们就先来下载这些文件
这些文件的下载有两种方式
第一种就是
用 Git 来下载
因为它可能是一个源码库
或者是用 Git-LFS 托管的一个一些文件
可以用 Git 来下载
另外还有一些文件是放在
Google 的网盘上了
这样的话就可以用浏览器直接下载了
具体怎么下
你是用浏览器还是用 curl 还是用 wget
都无所谓
都可以下下来
嗯这里就不再多说了
哦对了这里说一下
如果你在下载模型文件之前
要先运行一下 git lfs install 这个命令
确保它已经正确初始化了
因为这些文件下载需要比较长的时间
咱们可以利用这个时间来
把这个虚拟环境给它建好了
要创建虚拟环境的话
得先安装它叫一个 Conda 这个文件
Conda 有两个版本一个是叫 Anaconda
一个是 Miniconda
Anaconda 自带了大约 1,500 个依赖包
当然安装包以及安装所需要的
磁盘空间也会大一些
按他官方的介绍好像是 3GB 的样子吧
大约 3G
然后 Miniconda 就很小了
就只有几十兆
因为他不带那些预制的包
可以根据自己的情况选择就好
咱们这里用的是 Miniconda
刚才应该也注意到了
它大概只有 70MB
下载以后直接运行这个
.sh 文件去安装就可以了
根据提示一步一步的去安装就行了
如果你的
文件下下来是没有可执行权限的话
可以用 sh Miniconda3-py310_23.3.1-0-Linux-x86_64.sh
这样来运行
或者也可以给它加一下
+x
然后再直接运行这个文件就可以了
然后根据
提示一步一步的去安装就行了
在安装最后的一步它会提示你
需不需要初始化这个终端
选是就可以了
安装最后他会提示你
必须重新登录才能生效
这会你就按照根据他的要求重新退出
然后重新登录一下就可以了
重新登录以后
在你的命令提示符前面会多一个
(base)
这样的话就说明你的 Conda
已经安装成功了
当然也可以用
version 来验证一下
这个 base 就说明你当前用的是
基础环境
如果你创建了
一个新的虚拟环境并且激活以后
这里就会显示
你当前激活的那个环境的名称
如果你是在 Windows 下用 exe 安装 Conda 的话
最后有一个选项是安装给哪些用户
尽量选择只为我自己安装
不然的话他可能会提示说
这个程序在尝试写入系统文件
而导致安装失败
这也是安装的时候遇到的一个小坑
安装了 Conda 之后
就得去设置一下他的镜像源了
把这些内容去写到他的那个
配置文件里边
看到的配置文件
他的配置文件
在Linux上是在你的用户目录下
叫 .condarc 这个文件可以看一下
把这些内容整个
复制过来就可以了
然后运行一下 conda clean -i
把那个之前的缓存清理一下
要不然
他可能还是用的之前的镜像源的地址
设置了 Conda 的镜像源以后
还需要再设置一下
Pip 的镜像源
直接运行这两个命令就可以了
设置好了 Conda 和 Pip 的镜像源
就可以创建虚拟环境了
咱们先切换到
Mini-GP4 的源码的目录
就是这个目录这里边有一个 environment.yml
这么一个文件
创建虚拟环境需要这个文件
然后运行
conda env create 然后指定这个文件
create 的话
这里有两种方式来创建虚拟环境
第一种就是
按照他官网
给的这种就是直接指定他的环境配置文件
然后那个配置文件里边会
有这个环境的名称
叫 minigpt4
这种的话他会把那个环境的那个目录
放到你的用户目录下
如果你想指定一个其他的位置
来安装的话
可以用下面的这两个命令
就是指定一个 -p 的这么一个参数
把它放到一个指定的位置
然后激活的话
这两种方式也不太一样
就是第一种的话就是直接用名称激活
然后如果你指定了 -p 的话
那就要用你杠p后面的参数来激活
创建虚拟环境成功之后
它会提示你说你新创建的这个环境
是该用哪个命令去激活
然后该怎么回到基础环境
我现在激活了这个 minigpt4 的环境
他现在这里从 Base 就换成了
指定的 env 的这个目录
然后如果要回到之前的
回到基础环境的话
就运行这个 deactivate 就可以了
虚拟环境创建好之后
一定要激活这个环境
然后接下来所有的操作都是在
新的环境下运行的
不要在这个 base 下去运行
根据官网的说明
咱们需要合并他的那个模型参数文件
可以看一下他的说明
在这里提到的说
这个模型文件并不是
一个可以直接用的
然后是他的一个区别
这里边他也提到了说是因为这个
规则导致的
说他不能去发布这个模型文件
需要咱们来
先把这个两个模型文件合并一下
在合并之前需要先安装
Vicuna 就是这个 fast-chat
这个依赖包
直接运行这个命令就可以了
他自己会从 Github 上去下载源码
然后去
再去下载他依赖的那些依赖包
这些都是自动的咱们不用管
这里面有一个小坑是如果你在
Windows 上安装的话
可能会安装的时候他会提示你说
呃文件名过长导致安装失败
这个是因为他在下载
这个这个包的依赖包的时候
它会把原文件下载到一个
临时目录
但是 Windows 上默认的临时目录是一个
比较深的目录
这会的话就需要我们把这个
TMP 的那个目录
给他改成一个
相对来说较短的目录就可以了
安装完之后如果安装成功的话
用这个命令可以看一下
如果你这里提示说有 fschat 这个
包并且它的版本是 0.1.10
就说明你已经安装成功了
然后咱们有了这个 fschat 这个包
然后也有了咱们之前下载的
那两个模型文件
就是这个 vicuna-7b-delta-v0
还有这个 llama-7b
当然如果你的你的配置够好
你可以选择13B啊
这两个版本一定要一致
看他有没有下载完
就看那个这个目录里边运行一下 git pull
看他是不是提醒说
"Already up to date" 就可以了
如果没有提示这个的话
那说明他还没有下载完
当然你之前执行的那个下载命令
执行完以后
他也会回到那个命令提示服的状态
而不是在等待的
正在运行中的那种状态
在Linux上去下载的话可能会
提示一个类似于
那个文件在 Windows 上并未处理
好什么之类的这么一个提示
这个不用管它
只要
你运行 git pull 然后它提示 up to date
就没问题了
如果这两个都已经下载完了
然后咱们就可以运行这个合并命令
这个命令太长我就不读了
这里面有3个参数
一个是 base
base 就是 LLAMA 的那个模型的目录
就是这个目录的完整地址
绝对路径
然后 target
就是你最终要生成的模型文件的目录
然后这个 delta
就是之前提到的这个
7B delta 这个目录
然后就等他执行完就可以了
这个执行时间不是很长
比想象中要快很多
等这一步做完以后咱们就可以去
修改它的配置文件了
还是切换到它的源码目录
打开 minigpt4/configs/models/minigpt4.yml
找到第 16 行
把这里
配置成
刚才执行命令的时候的那个 target
那个参数的目录
配置完以后保存退出
然后再打开 eval_configs/minigpt4_eval.yaml
这里的
第 11 行
找到这个 checkpoint 的这一行
这里配置的是你下载的那个
pre-trained 的 Mini-GPT4 7B 的那个checkpoint 文件
这里是一个文件不要配置成目录
配置好以后保存退出
然后如果你想用提前下载那个
那两个文件就是刚才我提到的
在原码里下载的
文件你提前下载好了
需要想用它的话就要改一下
它的原码也是有两个地方需要改
一个是 minigpt4/models/mini_gpt4.py 的
27行它原来是这个样子的
之前是一个 HTTPS 的一个地址
谷歌的一个是 Google Drive
还是什么东西的一个地址
然后只把只需要把它改成
咱们下载提前下载好的那个文件的
实际的绝对路径就可以了
这个文件名跟他对上
然后另外一个地址（文件位置）是
minigpt4/modoles/eva_vit.py
在429行到432行
把这3（四）行
删掉也好或者是注释上也好
注释的话就是在前面加一个 # 号
换成咱们下载的那个文件的绝对路径
这个叫 eva_vit_g.pth
换成这个文件
换好以后保存退出
然后
就可以启动了
第一次启动的时候
可能还需要再下载一些依赖包
但是这个都是自动的不用管
以后再运行就不会了
然后咱们运行一下看看啊
用这个命令就可以启动程序
前面会提示说有一个 .so 文件找不到
咱们不用管
这个不影响程序的运行
如果是第一次运行的话
可能还需要下载一些依赖
等它装载 checkpoint
啊这里基本上已经启动成功了
他提示
可以通过这个 local 的地址来访问
然后他还提供了一个 public 的 URL
可以分享给通过公网访问
分分享给别人访问
咱们来看一下
嗯这就是 Mini-GPT4 的 demo 了
然后咱们从这里
上传一个图片看看
这是几个包子
上传完选择完图片之后
点这个上传按钮
等这个提示完成好了
就可以在这里输入文字和他对话了
哦他把这个识别成了饺子
嗯咱们换一个图片再试试
这是他官方的是一个例子
生成的网站还挺漂亮的
好了咱们回到安装的步骤上来
嗯可以看到这里有两个访问地址
一个是本地的
一个是共享的
但是这个地址是不能通过
本机的IP去访问的
因为它绑定到了 127.0.0.1
果想通过局域网的地址来访问的话
咱们需要改一下代码
打开 demo.py 这个文件
在最后一行
最后一行他默认是这个样子的
咱们把它改成下面的这个样子
就是新增了一个 server_name 这个参数
并把 server_name 设置成 0.0.0.0
然后如果你不想
创建那个公网访问的地址的话
就把这个 share 设置成 False
就可以了
然后保存
咱们再来运行一下看看
如果你不想用默认的
7860这个端口
也可以用那个
sever_pot 那个参数来指定它运行的端口
然后咱们访问一下看看
这个速度就快很多了
最后再说一下虚拟环境的问题
如果你退出登录了
像这样退出登录了
然后再次登录的时候
你会看到他的环境又回到了贝斯
这会需要重新
激活新创建的虚拟环境
从这里重新变成新的环境才可以
如果你不激活的话
那运行一下看看
他会提示说找不到模块
所以运行前
一定要使用这个命令来激活它
然后还有一个问题可能会有人遇到
就是大家也会发现这个视频
中间是有断了很长一段时间
就是上一次准备执行的时候发现
呃找不到显卡了
后来排查了一通原因之后发现是
系统内核升级了
它自动升级了
重刚好期间重启了一次机器
导致这个升级生效了
然后之前的那个驱动就不生效了
然后运行
的时候就会
提示说没有那个 cuda 的那个 Device
所以大家一定要保证那个
显卡的驱动是正确安装的
可以用这个命令来看一下
各个显卡的状态
这台机器还是很强的有8块显卡
嗯现在没有运行
那会运行的时候看应该是
用到了 10 个 G 左右吧
并没有用到官方说的 12 个 G
嗯不知道在实际的访问过程中他的
内存是不是还会再涨
好了以上就是今天的所有内容了
感谢大家的观看
如果喜欢我们的频道欢迎大家关注
谢谢大家
